<template>
  <div class="ticket-list">
    <!-- Controls -->
    <div class="controls">
      <input v-model="q" @input="debouncedFetch" type="text" placeholder="Search tickets…" />
      <select v-model="status" @change="fetchTickets">
        <option value="">All statuses</option>
        <option value="open">Open</option>
        <option value="pending">Pending</option>
        <option value="closed">Closed</option>
      </select>
      <button @click="fetchTickets">Refresh</button>
    </div>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="t in tickets" :key="t.id">
          <td>{{ t.id }}</td>
          <td class="title">{{ t.title }}</td>
          <td><span :class="'badge ' + t.status">{{ t.status }}</span></td>
          <td><span :class="'badge ' + (t.priority || 'none')">{{ t.priority || '—' }}</span></td>
          <td>{{ formatDate(t.updated_at) }}</td>
          <td class="actions">
            <button class="view">View</button>
            <button class="edit">Edit</button>
            <button class="delete">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pager -->
    <div v-if="totalPages > 1" class="pager">
      <button :disabled="page===1" @click="goto(page-1)">Prev</button>
      <span>Page {{ page }} of {{ totalPages }}</span>
      <button :disabled="page===totalPages" @click="goto(page+1)">Next</button>
    </div>
  </div>
</template>

<script>
export default {
  name: "TicketList",
  data() {
    return {
      tickets: [],
      q: "",
      status: "",
      page: 1,
      totalPages: 1
    }
  },
  methods: {
    async fetchTickets() {
      const res = await fetch(`/api/tickets?q=${this.q}&status=${this.status}&page=${this.page}`)
      const data = await res.json()
      this.tickets = data.data || data
      this.totalPages = data.last_page || 1
    },
    goto(p) {
      this.page = p
      this.fetchTickets()
    },
    formatDate(iso) {
      if (!iso) return "—"
      return new Date(iso).toLocaleString()
    },
    debouncedFetch: (() => {
      let timer
      return function () {
        clearTimeout(timer)
        timer = setTimeout(() => this.fetchTickets(), 400)
      }
    })()
  },
  mounted() {
    this.fetchTickets()
  }
}
</script>

<style scoped>
.ticket-list {
  padding: 20px;
  font-family: Arial, sans-serif;
}

.controls {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.controls input,
.controls select {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.controls button {
  padding: 6px 12px;
  background: #4a6cf7;
  border: none;
  border-radius: 4px;
  color: #fff;
  cursor: pointer;
}
.controls button:hover {
  background: #3652c9;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
thead {
  background: #f5f5f5;
}
th, td {
  text-align: left;
  padding: 10px;
  border-bottom: 1px solid #ddd;
}
.title {
  max-width: 250px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Badges */
.badge {
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  text-transform: capitalize;
}
.badge.open { background: #d4f8d4; color: #2a7d2a; }
.badge.pending { background: #fff3cd; color: #856404; }
.badge.closed { background: #e2e3e5; color: #555; }
.badge.low { background: #dbeafe; color: #1e40af; }
.badge.medium { background: #fde68a; color: #92400e; }
.badge.high { background: #fed7d7; color: #9b2c2c; }
.badge.urgent { background: #f87171; color: white; }
.badge.none { background: #f0f0f0; color: #777; }

.actions button {
  margin-right: 5px;
  padding: 4px 10px;
  font-size: 13px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.actions .view { background: #3b82f6; color: white; }
.actions .edit { background: #facc15; color: black; }
.actions .delete { background: #ef4444; color: white; }

.actions .view:hover { background: #2563eb; }
.actions .edit:hover { background: #eab308; }
.actions .delete:hover { background: #dc2626; }

.pager {
  margin-top: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.pager button {
  padding: 6px 12px;
  border: 1px solid #ccc;
  background: #f9f9f9;
  cursor: pointer;
  border-radius: 4px;
}
.pager button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
